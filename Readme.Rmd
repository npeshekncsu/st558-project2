---
title: "ST-558, Project 2"
author: "Nataliya Peshekhodko"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Vignette for reading and summarizing data from an IQAir APIs

## Overall Goal

Vignettes are explanations of some concept, package, etc. with text, code, and output interweaved. Our goal with this project is to create a vignette about contacting an [IQAir APIs](https://www.iqair.com/dashboard/api) using custom functions to query, parse, and return well-structured data.  IQAir APIs provide information about **real time air quality data**.
API endpoint used https://www.iqair.com/dashboard/api

## Packages

Packages required to run code included in that analysis:

```{r, message=FALSE, warning=FALSE}
library(httr)
library(dplyr)
library(tibble)
library(jsonlite)
library(ggplot2)
```


  - `httr` - required for making HTTP requests
  - `dplyr` - required for data manipulation
  - `tibble` - required for formatting data frame
  - `jsonlite` - required for converting JSON data from/to R objects
  - `ggplot2` - required for creating graphs
  

Define variable for API key required for the authentication during HTTP request:

```{r}
key = '97d5c2b8-7656-4974-827e-9d59486f7777'
```


## Functions for reading data from IQAir APIs

This section is dedicated for helper functions required for HTTP requests. 

Function to retrieve `states` based on the `country` name. States returned as a list.


```{r}
get_states <- function(country, api_key = key) {
  url = 'http://api.airvisual.com/v2/states'
  resp = GET(url, query = list(key = api_key, 
                               country = country))
  parsed = fromJSON(rawToChar(resp$content))
  
  return (as.list(parsed$data)$state)
}
```

Function to get `cities` based on the provided `country` and `state`. Cities returned as a list.


```{r}
get_cities <- function(country, state, api_key = key) {
  url = 'http://api.airvisual.com/v2/cities'
  
  resp = GET(url, query = list(key = api_key, 
                               country = country,
                               state = state))
  parsed = fromJSON(rawToChar(resp$content))
  return (as.list(parsed$data)$city)
}
```

Function to return air quality based on the `country`, `state` and `city`. If `city` is not provided, random sample of the size `sample_size` will be chosen from the cities which belong to the `state`. If `weather_metrics = TRUE` in addition to air quality metrics, weather conditions like, temperature, humidity, wind speed and pressure will be returned. 


```{r}
get_air_quality_per_city <- function(country, 
                                     state, 
                                     city = NULL,
                                     weather_metrics = TRUE,
                                     sample_size = 5,
                                     api_key = key) {
  
  results = tibble()
  url = 'http://api.airvisual.com/v2/city'
 
  if (is.null(city)) {
    cities = get_cities(country, state)
  
    if (length(cities) > sample_size) {
      set.seed(123)
      cities = sample(cities, size = sample_size)
    }
    
    for (city in cities) {
      Sys.sleep(15)
      resp = GET(url, query = list(key = key, 
                                   country = country,
                                   state = state,
                                   city = city))
      parsed = fromJSON(rawToChar(resp$content))
      
      if (weather_metrics == TRUE) {
        subset_df = tibble(aqius = parsed$data$current$pollution$aqius, 
                           aqicn = parsed$data$current$pollution$aqicn, 
                           city = parsed$data$city,
                           state = parsed$data$state,
                           country = parsed$data$country,
                           temp_cels = parsed$data$current$weather$tp,
                           humidity = parsed$data$current$weather$hu, 
                           wind_speed = parsed$data$current$weather$ws,
                           atm_pressure = parsed$data$current$weather$pr)
      } else {
        subset_df = tibble(aqius = parsed$data$current$pollution$aqius, 
                           aqicn = parsed$data$current$pollution$aqicn, 
                           city = parsed$data$city,
                           state = parsed$data$state,
                           country = parsed$data$country)
      }
      results <- bind_rows(results, subset_df)
    
  }
    } else {
      resp = GET(url, query = list(key = key, 
                                   country = country,
                                   state = state,
                                   city = city))
      parsed = fromJSON(rawToChar(resp$content))
      if (weather_metrics == TRUE) {
        subset_df = tibble(aqius = parsed$data$current$pollution$aqius, 
                           aqicn = parsed$data$current$pollution$aqicn, 
                           city = parsed$data$city,
                           state = parsed$data$state,
                           country = parsed$data$country,
                           temp_cels = parsed$data$current$weather$tp,
                           humidity = parsed$data$current$weather$hu, 
                           wind_speed = parsed$data$current$weather$ws,
                           atm_pressure = parsed$data$current$weather$pr)
      } else {
        subset_df = tibble(aqius = parsed$data$current$pollution$aqius, 
                           aqicn = parsed$data$current$pollution$aqicn, 
                           city = parsed$data$city,
                           state = parsed$data$state,
                           country = parsed$data$country)
      }
      results <- bind_rows(results, subset_df)
  }
  return (results)
}
```



```{r}
get_air_quality_per_country <- function(country, 
                                        weather_metrics = TRUE,
                                        sample_size = 5,
                                        api_key = key) {
  
  results = tibble()
  url = 'http://api.airvisual.com/v2/city'
  
  
  states = get_states(country, api_key = key)
  
  set.seed(2)
  states = sample(states, size = sample_size)
  
  
  for (state in states) {
    Sys.sleep(15)
    cities = get_cities(country, state, api_key = key)
    set.seed(4)
    city = sample(cities, size = 1)
    
    Sys.sleep(15)
    resp = GET(url, query = list(key = api_key, 
                                 country = country,
                                 state = state,
                                 city = city))
    parsed = fromJSON(rawToChar(resp$content))
    subset_df = tibble(aqius = parsed$data$current$pollution$aqius, 
                       aqicn = parsed$data$current$pollution$aqicn, 
                       city = parsed$data$city,
                       state = parsed$data$state,
                       country = parsed$data$country,
                       temp_cels = parsed$data$current$weather$tp,
                       humidity = parsed$data$current$weather$hu, 
                       wind_speed = parsed$data$current$weather$ws,
                       atm_pressure = parsed$data$current$weather$pr)
    results <- bind_rows(results, subset_df)
  }
  return (results)
}
```


```{r}
res_usa_cal =  get_air_quality_per_city (country = 'USA', state = 'California', sample_size = 3)
```

```{r}
res_usa_cal
```


```{r}
t = get_air_quality_per_country(country = 'USA', sample_size = 2)
t
```

## Exploratory Data Analysis


Let's look at air pollution for different countries across the globe: China, USA, France, India, Kenya.

```{r}
air_usa = get_air_quality_per_country(country = 'USA', sample_size = 3)
```

```{r}
air_usa
```




```{r}
air_china = get_air_quality_per_country(country = 'China', sample_size = 3)
```

```{r}
air_china
```

```{r}
air_poland = get_air_quality_per_country(country = 'Poland', sample_size = 3)
air_poland
```



```{r}
air_australia = get_air_quality_per_country(country = 'Australia', sample_size = 3)
air_australia
```


```{r}



all = bind_rows(air_australia, air_poland, air_china, air_usa)


all <- all %>%
  mutate(aqius_category = case_when(
    aqius < 50 ~ "good",
    aqius >= 50 & aqius <= 100 ~ "moderate",
    aqius > 100 ~ "unhealthy"
  )) %>%
  mutate(aqicn_category = case_when(
    aqius < 50 ~ "excellent",
    aqius >= 50 & aqius <= 100 ~ "good",
    aqius > 100 ~ "polluted"
  )) %>%
  mutate(humidity_category = case_when(
    humidity <= 40 ~ 'low',
    humidity > 40 & humidity <= 60 ~ 'normal',
    humidity > 60 ~ 'high'
  ))

 all 
  
```

```{r}
table(all$aqius_category, all$country)
table(all$aqicn_category, all$country)
table(all$aqius_category, all$humidity_category)
```

```{r}
result <- all %>%
  group_by(country) %>%
  summarize(mean_aqius = mean(aqius), mean_aqicn = mean(aqicn)) 
result
```



```{r}

ggplot(result, aes(x = country, y = mean_aqius)) +
  geom_bar(stat = "identity", fill = "blue", alpha = 0.5) +
  labs(title = "Means of AQIUS per country", x = "Country", y = "Mean of AQUIS")


ggplot(result, aes(x = country, y = mean_aqicn)) +
  geom_bar(stat = "identity", fill = "red", alpha = 0.5) +
  labs(title = "Means of AQICN per country", x = "Country", y = "Mean of AQUCN")
```

```{r}
ggplot(all, aes(x = country, y = aqius, fill = country)) +
  geom_boxplot() +
  labs(title = "AQIUS per country", x = "Country", y = "AQIUS") +
  theme_minimal()
```

```{r}
#library(heatmaply)

data <- as.matrix(all %>% select(aqius, aqicn, temp_cels, humidity, wind_speed, atm_pressure))
#data
# Default Heatmap
heatmap(data, col = heat.colors(10),  Colv = NA, Rowv = NA, scale="column")
#legend(
#  "topright",             # Legend position
#  legend = c("Low", "High"),  # Legend labels
#  fill = heat.colors(2),      # Colors for the legend
#  title = "Legend"            # Legend title
#)
```

```{r}
ggplot(all, aes(x = temp_cels, y = aqius)) +
  geom_point() +                  # Add scatter points
  geom_smooth(method = "lm",      # Add a linear regression line
              formula = y ~ x,    # Regression formula
              se = TRUE) +      # Don't display confidence interval
  labs(title = "Temperature vs AQIUS",  # Main title
       x = "Temperature, Celsius",              # X-axis label
       y = "AQIUS")  
```


### Looking at USA states


```{r}
air_california = get_air_quality_per_city(country = 'USA', state = 'California', sample_size = 5)
air_california
```

```{r}
air_colorado = get_air_quality_per_city(country = 'USA', state = 'Colorado', sample_size = 5)
air_colorado
```

```{r}
air_minnesota = get_air_quality_per_city(country = 'USA', state = 'Minnesota', sample_size = 5)
air_minnesota
```

```{r}
air_florida = get_air_quality_per_city(country = 'USA', state = 'Florida', sample_size = 5)
air_florida
```



```{r}
air_michigan = get_air_quality_per_city(country = 'USA', state = 'Michigan', sample_size = 5)
air_michigan
```
```{r}
all_per_state = bind_rows(air_michigan, air_florida, air_minnesota, air_colorado, air_california)
```



```{r}
all_per_state <- all_per_state %>%
  mutate(aqius_category = case_when(
    aqius < 50 ~ "good",
    aqius >= 50 & aqius <= 100 ~ "moderate",
    aqius > 100 ~ "unhealthy"
  )) %>%
  mutate(aqicn_category = case_when(
    aqius < 50 ~ "excellent",
    aqius >= 50 & aqius <= 100 ~ "good",
    aqius > 100 ~ "polluted"
  )) %>%
  mutate(humidity_category = case_when(
    humidity <= 40 ~ 'low',
    humidity > 40 & humidity <= 60 ~ 'normal',
    humidity > 60 ~ 'high'
  ))
all_per_state 
```


```{r}
table(all_per_state$aqius_category, all_per_state$state)
table(all_per_state$aqicn_category, all_per_state$state)
table(all_per_state$aqius_category, all_per_state$humidity_category)
```

```{r}
result <- all_per_state %>%
  group_by(state) %>%
  summarize(mean_aqius = mean(aqius), mean_aqicn = mean(aqicn)) 
result
```
```{r}
all_per_state
```
```{r}
ggplot(all_per_state, aes(x = wind_speed, y = aqius)) +
  geom_point() +                  # Add scatter points
  geom_smooth(method = "lm",      # Add a linear regression line
              formula = y ~ x,    # Regression formula
              se = TRUE) +      # Don't display confidence interval
  labs(title = "Temperature vs AQIUS",  # Main title
       x = "Wind speed",              # X-axis label
       y = "AQIUS")  
```


```{r}
ggplot(all_per_state, aes(x = temp_cels, y = aqius)) +
  geom_point() +                  # Add scatter points
  geom_smooth(method = "lm",      # Add a linear regression line
              formula = y ~ x,    # Regression formula
              se = TRUE) +      # Don't display confidence interval
  labs(title = "Temperature vs AQIUS",  # Main title
       x = "Temperature",              # X-axis label
       y = "AQIUS")  
```


```{r}
ggplot(all_per_state, aes(x = humidity, y = aqius)) +
  geom_point() +                  # Add scatter points
  geom_smooth(method = "lm",      # Add a linear regression line
              formula = y ~ x,    # Regression formula
              se = TRUE) +      # Don't display confidence interval
  labs(title = "Temperature vs AQIUS",  # Main title
       x = "Humidity",              # X-axis label
       y = "AQIUS")  
```

```{r}
ggplot(all_per_state, aes(x = state, y = aqius, fill = state)) +
  geom_boxplot() +
  labs(title = "AQIUS per state", x = "State", y = "AQIUS") +
  theme_minimal()
```